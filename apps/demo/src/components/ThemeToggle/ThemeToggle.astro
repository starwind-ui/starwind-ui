---
import Moon from "@tabler/icons/outline/moon.svg";
import Sun from "@tabler/icons/outline/sun.svg";

import { Toggle } from "@/components/starwind/toggle";

interface Props {
  class?: string;
}

const { class: className } = Astro.props as Props;
---

<Toggle
  class:list={[
    "group hover:border-muted-foreground rounded-full hover:bg-transparent data-[state=on]:bg-transparent",
    className,
  ]}
  variant="outline"
  syncGroup="theme"
  aria-label="Toggle theme"
  data-theme-toggle
>
  <Sun class="size-5 group-data-[state=on]:hidden" />
  <Moon class="size-5 group-data-[state=off]:hidden" />
</Toggle>

<script>
  import type { ToggleChangeEvent } from "@/components/starwind/toggle";

  function changeTheme(theme: "dark" | "light") {
    if (theme === "dark") {
      document.documentElement.classList.add("dark");
    } else {
      document.documentElement.classList.remove("dark");
    }
  }

  function initThemeToggle() {
    const themeToggleBtns = document.querySelectorAll<HTMLButtonElement>("[data-theme-toggle]");

    // Get initial theme from localStorage
    const colorTheme = localStorage.getItem("colorTheme") || "light";
    const isDark = colorTheme === "dark";

    // Add event listener to only the first toggle button
    // Since they're synced, we only need one to handle theme changes
    if (themeToggleBtns.length > 0) {
      const handleToggleChange = (event: Event) => {
        const { pressed } = (event as ToggleChangeEvent).detail;

        // Update theme based on toggle state
        // pressed = true means dark mode (moon icon showing)
        // pressed = false means light mode (sun icon showing)
        if (pressed) {
          changeTheme("dark");
          localStorage.setItem("colorTheme", "dark");
        } else {
          changeTheme("light");
          localStorage.setItem("colorTheme", "light");
        }
      };

      themeToggleBtns[0].addEventListener("starwind-toggle:change", handleToggleChange);

      // Set initial state by clicking the first toggle if needed
      const currentState = themeToggleBtns[0].getAttribute("data-state");
      const shouldBeOn = isDark;
      const isOn = currentState === "on";

      // Only click if the state doesn't match what it should be
      if (shouldBeOn !== isOn) {
        themeToggleBtns[0].click();
      }
    }
  }

  // runs on initial page load
  initThemeToggle();

  // runs on view transitions navigation
  document.addEventListener("astro:after-swap", initThemeToggle);
</script>
