---
import type { HTMLAttributes } from "astro/types";

type ToastOptions = {
  title?: string;
  description?: string;
  variant?: "default" | "success" | "error" | "warning" | "info";
  duration?: number;
  action?: {
    label: string;
    onClick: string;
  };
};

type Props = HTMLAttributes<"button"> & {
  toast: ToastOptions;
  asChild?: boolean;
};

const { class: className, toast: toastOptions, asChild = false, ...rest } = Astro.props;

const toastData = JSON.stringify(toastOptions);
---

{
  asChild ? (
    <span
      class:list={["starwind-toast-trigger", className]}
      data-slot="toast-trigger"
      data-toast={toastData}
      data-as-child
      {...rest}
    >
      <slot />
    </span>
  ) : (
    <button
      type="button"
      class:list={["starwind-toast-trigger", className]}
      data-slot="toast-trigger"
      data-toast={toastData}
      {...rest}
    >
      <slot />
    </button>
  )
}

<script>
  const setupTriggers = () => {
    document.querySelectorAll('[data-slot="toast-trigger"]').forEach((trigger) => {
      const el = trigger as HTMLElement;
      if (el.hasAttribute("data-initialized")) return;
      el.setAttribute("data-initialized", "");

      let targetEl: HTMLElement = el;
      if (el.hasAttribute("data-as-child") && el.firstElementChild) {
        targetEl = el.firstElementChild as HTMLElement;
      }

      targetEl.addEventListener("click", () => {
        const toastData = el.dataset.toast;
        if (!toastData) return;

        try {
          const options = JSON.parse(toastData);

          if (options.action?.onClick && typeof options.action.onClick === "string") {
            const onClickFn = new Function(options.action.onClick);
            options.action.onClick = onClickFn;
          }

          (window as any).starwindToast?.add(options);
        } catch (e) {
          console.error("Failed to parse toast options:", e);
        }
      });
    });
  };

  setupTriggers();
  document.addEventListener("astro:after-swap", setupTriggers);
  document.addEventListener("starwind:init", setupTriggers);
</script>
