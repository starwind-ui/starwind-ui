---
import type { HTMLAttributes } from "astro/types";
import { tv } from "tailwind-variants";

export const prose = tv({
  base: "sw-prose max-w-[65ch]",
  variants: {
    size: {
      sm: "sw-prose-sm",
      base: "sw-prose-base",
      lg: "sw-prose-lg",
      xl: "sw-prose-xl",
      "2xl": "sw-prose-2xl",
    },
  },
  defaultVariants: {
    size: "base",
  },
});

type Props = HTMLAttributes<"div"> & {
  /**
   * The size variant for the prose content.
   * @default "base"
   */
  size?: "sm" | "base" | "lg" | "xl" | "2xl";
};

const { class: className, size, ...rest } = Astro.props;
---

<div class:list={[prose({ size, class: className })]} {...rest}><slot /></div>

<style is:global>
  /* ==========================================================================
   * Starwind Prose - Typography styles for markdown content
   * Inspired by Tailwind Typography and Astro Starlight
   * ========================================================================== */

  /* --------------------------------------------------------------------------
   * Size Variants - Custom properties for responsive sizing
   * Use classes like: sw-prose-sm, sw-prose-base, etc.
   * Supports responsive: "sw-prose-sm md:sw-prose-base" TODO: NO IT DOESN'T!!!
   * -------------------------------------------------------------------------- */

  .sw-prose-sm {
    --sw-prose-font-size: var(--text-sm);
    --sw-prose-line-height: 1.714;
    --sw-prose-spacing: 1.143em;
    --sw-prose-heading-spacing: 1.5em;
    --sw-prose-h1-size: 2.143em;
    --sw-prose-h2-size: 1.429em;
    --sw-prose-h3-size: 1.286em;
    --sw-prose-h4-size: 1em;
    --sw-prose-code-size: 0.857em;
    --sw-prose-list-indent: 1.571em;
  }

  .sw-prose-base {
    --sw-prose-font-size: var(--text-base);
    --sw-prose-line-height: 1.75;
    --sw-prose-spacing: 1.25em;
    --sw-prose-heading-spacing: 1.5em;
    --sw-prose-h1-size: 2.25em;
    --sw-prose-h2-size: 1.5em;
    --sw-prose-h3-size: 1.25em;
    --sw-prose-h4-size: 1em;
    --sw-prose-code-size: 0.875em;
    --sw-prose-list-indent: 1.625em;
  }

  .sw-prose-lg {
    --sw-prose-font-size: var(--text-lg);
    --sw-prose-line-height: 1.778;
    --sw-prose-spacing: 1.333em;
    --sw-prose-heading-spacing: 1.556em;
    --sw-prose-h1-size: 2.667em;
    --sw-prose-h2-size: 1.667em;
    --sw-prose-h3-size: 1.333em;
    --sw-prose-h4-size: 1em;
    --sw-prose-code-size: 0.889em;
    --sw-prose-list-indent: 1.556em;
  }

  .sw-prose-xl {
    --sw-prose-font-size: var(--text-xl);
    --sw-prose-line-height: 1.8;
    --sw-prose-spacing: 1.2em;
    --sw-prose-heading-spacing: 1.8em;
    --sw-prose-h1-size: 2.8em;
    --sw-prose-h2-size: 1.8em;
    --sw-prose-h3-size: 1.5em;
    --sw-prose-h4-size: 1em;
    --sw-prose-code-size: 0.9em;
    --sw-prose-list-indent: 1.6em;
  }

  .sw-prose-2xl {
    --sw-prose-font-size: var(--text-2xl);
    --sw-prose-line-height: 1.667;
    --sw-prose-spacing: 1.333em;
    --sw-prose-heading-spacing: 1.667em;
    --sw-prose-h1-size: 2.667em;
    --sw-prose-h2-size: 2em;
    --sw-prose-h3-size: 1.5em;
    --sw-prose-h4-size: 1em;
    --sw-prose-code-size: 0.833em;
    --sw-prose-list-indent: 1.583em;
  }

  /* --------------------------------------------------------------------------
   * Base Styles
   * -------------------------------------------------------------------------- */

  .sw-prose {
    font-size: var(--sw-prose-font-size);
    line-height: var(--sw-prose-line-height);
    color: --alpha(var(--color-foreground) / 80%);
  }

  /* Vertical rhythm - spacing between block elements */
  .sw-prose
    :not(a, strong, em, del, span, input, code, br)
    + :not(a, strong, em, del, span, input, code, br, :where(.not-sw-prose *)) {
    margin-top: var(--sw-prose-spacing);
  }

  /* Headings after non-headings have more spacing */
  .sw-prose
    :not(h1, h2, h3, h4, h5, h6)
    + :is(h1, h2, h3, h4, h5, h6):not(:where(.not-sw-prose *)) {
    margin-top: var(--sw-prose-heading-spacing);
  }

  /* First/last child margin reset */
  .sw-prose > :first-child:not(:where(.not-sw-prose *)) {
    margin-top: 0;
  }
  .sw-prose > :last-child:not(:where(.not-sw-prose *)) {
    margin-bottom: 0;
  }

  /* --------------------------------------------------------------------------
   * Headings
   * -------------------------------------------------------------------------- */

  .sw-prose :is(h1, h2, h3, h4, h5, h6):not(:where(.not-sw-prose *)) {
    color: var(--color-foreground);
    font-weight: var(--font-weight-semibold);
    line-height: 1.25;
    opacity: 1;
  }

  .sw-prose h1:not(:where(.not-sw-prose *)) {
    font-size: var(--sw-prose-h1-size);
    font-weight: var(--font-weight-bold);
    margin-bottom: 0.889em;
  }

  .sw-prose h2:not(:where(.not-sw-prose *)) {
    font-size: var(--sw-prose-h2-size);
    margin-bottom: 0.667em;
  }

  .sw-prose h3:not(:where(.not-sw-prose *)) {
    font-size: var(--sw-prose-h3-size);
    margin-bottom: 0.6em;
  }

  .sw-prose h4:not(:where(.not-sw-prose *)) {
    font-size: var(--sw-prose-h4-size);
    margin-bottom: 0.5em;
  }

  .sw-prose h5:not(:where(.not-sw-prose *)),
  .sw-prose h6:not(:where(.not-sw-prose *)) {
    font-size: var(--sw-prose-font-size);
    margin-bottom: 0.5em;
  }

  /* Reset margin-top after headings */
  .sw-prose :is(h1, h2, h3, h4, h5, h6) + *:not(:where(.not-sw-prose *)) {
    margin-top: 0;
  }

  /* --------------------------------------------------------------------------
   * Paragraphs
   * -------------------------------------------------------------------------- */

  .sw-prose p:not(:where(.not-sw-prose *)) {
    margin-top: var(--sw-prose-spacing);
    margin-bottom: var(--sw-prose-spacing);
  }

  /* --------------------------------------------------------------------------
   * Links
   * -------------------------------------------------------------------------- */

  .sw-prose a:not(:where(.not-sw-prose *)) {
    color: var(--color-foreground);
    text-decoration: underline;
    text-decoration-color: var(--color-primary-accent);
    text-underline-offset: 0.15em;
    font-weight: 500;
    opacity: 1;
    transition-property: color;
    transition-timing-function: var(--tw-ease, var(--default-transition-timing-function));
    transition-duration: var(--tw-duration, var(--default-transition-duration));
  }

  .sw-prose a:hover:not(:where(.not-sw-prose *)) {
    color: var(--color-primary-accent);
  }

  /* --------------------------------------------------------------------------
   * Strong, Bold, Emphasis
   * -------------------------------------------------------------------------- */

  .sw-prose strong:not(:where(.not-sw-prose *)) {
    color: var(--color-foreground);
    font-weight: 600;
    opacity: 1;
  }

  .sw-prose :is(a, blockquote, thead th) strong:not(:where(.not-sw-prose *)) {
    color: inherit;
  }

  /* --------------------------------------------------------------------------
   * Lists
   * -------------------------------------------------------------------------- */

  .sw-prose :is(ul, ol):not(:where(.not-sw-prose *)) {
    padding-inline-start: var(--sw-prose-list-indent);
    margin-top: var(--sw-prose-spacing);
    margin-bottom: var(--sw-prose-spacing);
  }

  .sw-prose ul:not(:where(.not-sw-prose *)) {
    list-style-type: disc;
  }

  .sw-prose ol:not(:where(.not-sw-prose *)) {
    list-style-type: decimal;
  }

  .sw-prose li:not(:where(.not-sw-prose *)) {
    margin-top: 0.5em;
    margin-bottom: 0.5em;
    padding-inline-start: 0.375em;
    overflow-wrap: anywhere;
  }

  .sw-prose li + li:not(:where(.not-sw-prose *)) {
    margin-top: 0.25rem;
  }

  .sw-prose :is(ul, ol) :is(ul, ol):not(:where(.not-sw-prose *)) {
    margin-top: 0.75em;
    margin-bottom: 0.75em;
  }

  .sw-prose ol > li::marker:not(:where(.not-sw-prose *)) {
    font-weight: 400;
    color: var(--color-muted-foreground);
  }

  .sw-prose ul > li::marker:not(:where(.not-sw-prose *)) {
    color: var(--color-muted-foreground);
  }

  /* Definition lists */
  .sw-prose dl:not(:where(.not-sw-prose *)) {
    margin-top: var(--sw-prose-spacing);
    margin-bottom: var(--sw-prose-spacing);
  }

  .sw-prose dt:not(:where(.not-sw-prose *)) {
    color: var(--color-foreground);
    font-weight: 600;
    margin-top: var(--sw-prose-spacing);
    opacity: 1;
  }

  .sw-prose dd:not(:where(.not-sw-prose *)) {
    margin-top: 0.25rem;
    padding-inline-start: var(--sw-prose-list-indent);
  }

  .sw-prose dt + dt:not(:where(.not-sw-prose *)),
  .sw-prose dt + dd:not(:where(.not-sw-prose *)),
  .sw-prose dd + dd:not(:where(.not-sw-prose *)) {
    margin-top: 0.25rem;
  }

  /* --------------------------------------------------------------------------
   * Blockquotes
   * -------------------------------------------------------------------------- */

  .sw-prose blockquote:not(:where(.not-sw-prose *)) {
    font-style: italic;
    color: var(--color-foreground);
    border-inline-start: 4px solid var(--color-border);
    padding-inline-start: 1rem;
    margin-top: var(--sw-prose-spacing);
    margin-bottom: var(--sw-prose-spacing);
  }

  .sw-prose blockquote p:first-of-type::before:not(:where(.not-sw-prose *)) {
    content: open-quote;
  }

  .sw-prose blockquote p:last-of-type::after:not(:where(.not-sw-prose *)) {
    content: close-quote;
  }

  /* --------------------------------------------------------------------------
   * Code (inline)
   * -------------------------------------------------------------------------- */

  .sw-prose code:not(:where(.not-sw-prose *)) {
    background-color: var(--color-muted);
    color: var(--color-foreground);
    font-size: var(--sw-prose-code-size);
    font-weight: 500;
    padding: 0.125rem 0.375rem;
    border-radius: 0.25rem;
    opacity: 1;
  }

  .sw-prose :is(h1, h2, h3, h4, h5, h6) code:not(:where(.not-sw-prose *)) {
    font-size: inherit;
  }

  .sw-prose a code:not(:where(.not-sw-prose *)) {
    color: inherit;
  }

  /* --------------------------------------------------------------------------
   * Pre / Code blocks
   * -------------------------------------------------------------------------- */

  .sw-prose pre:not(:where(.not-sw-prose *)) {
    border: 1px solid var(--color-border);
    border-radius: var(--radius-md, 0.375rem);
    padding: 0.75rem 1rem;
    font-size: var(--sw-prose-code-size);
    line-height: 1.714;
    overflow-x: auto;
    tab-size: 2;
    margin-top: var(--sw-prose-spacing);
    margin-bottom: var(--sw-prose-spacing);
  }

  .sw-prose pre code:not(:where(.not-sw-prose *)) {
    all: unset;
    font-family: (--font-mono);
  }

  /* --------------------------------------------------------------------------
   * Horizontal Rules
   * -------------------------------------------------------------------------- */

  .sw-prose hr:not(:where(.not-sw-prose *)) {
    border: 0;
    border-top: 1px solid var(--color-border);
    margin-top: 3em;
    margin-bottom: 3em;
  }

  .sw-prose hr + *:not(:where(.not-sw-prose *)) {
    margin-top: 0;
  }

  /* --------------------------------------------------------------------------
   * Images and Media
   * -------------------------------------------------------------------------- */

  .sw-prose :is(img, picture, video, canvas, svg, iframe):not(:where(.not-sw-prose *)) {
    display: block;
    max-width: 100%;
    height: auto;
    margin-top: var(--sw-prose-spacing);
    margin-bottom: var(--sw-prose-spacing);
  }

  .sw-prose picture > img:not(:where(.not-sw-prose *)) {
    margin-top: 0;
    margin-bottom: 0;
  }

  /* --------------------------------------------------------------------------
   * Figures and Captions
   * -------------------------------------------------------------------------- */

  .sw-prose figure:not(:where(.not-sw-prose *)) {
    margin-top: var(--sw-prose-spacing);
    margin-bottom: var(--sw-prose-spacing);
  }

  .sw-prose figure > *:not(:where(.not-sw-prose *)) {
    margin-top: 0;
    margin-bottom: 0;
  }

  .sw-prose figcaption:not(:where(.not-sw-prose *)) {
    color: var(--color-muted-foreground);
    font-size: var(--sw-prose-code-size);
    margin-top: 0.857em;
  }

  /* --------------------------------------------------------------------------
   * Tables
   * -------------------------------------------------------------------------- */

  .sw-prose table:not(:where(.not-sw-prose *)) {
    width: 100%;
    table-layout: auto;
    margin-top: var(--sw-prose-spacing);
    margin-bottom: var(--sw-prose-spacing);
    font-size: var(--sw-prose-code-size);
    line-height: 1.714;
  }

  .sw-prose thead:not(:where(.not-sw-prose *)) {
    border-bottom: 1px solid var(--color-border);
  }

  .sw-prose thead th:not(:where(.not-sw-prose *)) {
    color: var(--color-foreground);
    font-weight: 600;
    vertical-align: bottom;
    padding-inline-end: 0.571em;
    padding-bottom: 0.571em;
    padding-inline-start: 0.571em;
    text-align: start;
    opacity: 1;
  }

  .sw-prose thead th:first-child:not(:where(.not-sw-prose *)) {
    padding-inline-start: 0;
  }

  .sw-prose thead th:last-child:not(:where(.not-sw-prose *)) {
    padding-inline-end: 0;
  }

  .sw-prose tbody tr:not(:where(.not-sw-prose *)) {
    border-bottom: 1px solid var(--color-border);
  }

  .sw-prose tbody tr:last-child:not(:where(.not-sw-prose *)) {
    border-bottom-width: 0;
  }

  .sw-prose :is(td, th):not(:where(.not-sw-prose *)) {
    vertical-align: baseline;
    padding: 0.571em;
  }

  .sw-prose :is(td:first-child, th:first-child):not(:where(.not-sw-prose *)) {
    padding-inline-start: 0;
  }

  .sw-prose :is(td:last-child, th:last-child):not(:where(.not-sw-prose *)) {
    padding-inline-end: 0;
  }

  .sw-prose tfoot:not(:where(.not-sw-prose *)) {
    border-top: 1px solid var(--color-border);
  }

  .sw-prose tfoot td:not(:where(.not-sw-prose *)) {
    vertical-align: top;
  }

  /* --------------------------------------------------------------------------
   * Keyboard Input
   * -------------------------------------------------------------------------- */

  .sw-prose kbd:not(:where(.not-sw-prose *)) {
    font-weight: 500;
    font-family: inherit;
    font-size: var(--sw-prose-code-size);
    color: var(--color-foreground);
    background-color: var(--color-muted);
    padding: 0.1875em 0.375em;
    border-radius: 0.3125rem;
    box-shadow:
      0 0 0 1px color-mix(in srgb, var(--color-foreground) 10%, transparent),
      0 2px 0 color-mix(in srgb, var(--color-foreground) 10%, transparent);
    opacity: 1;
  }

  /* --------------------------------------------------------------------------
   * Details / Summary (Starlight-inspired)
   * -------------------------------------------------------------------------- */

  .sw-prose details:not(:where(.not-sw-prose *)) {
    --sw-details-border-color: var(--color-border);
    --sw-details-border-color-hover: var(--color-primary-accent);

    border-inline-start: 2px solid var(--sw-details-border-color);
    padding-inline-start: 1rem;
    margin-top: var(--sw-prose-spacing);
    margin-bottom: var(--sw-prose-spacing);
  }

  .sw-prose details:not([open]):hover:not(:where(.not-sw-prose *)),
  .sw-prose details:has(> summary:hover):not(:where(.not-sw-prose *)) {
    border-color: var(--sw-details-border-color-hover);
  }

  .sw-prose summary:not(:where(.not-sw-prose *)) {
    color: var(--color-foreground);
    cursor: pointer;
    display: block;
    font-weight: 600;
    margin-inline-start: -0.5rem;
    padding-inline-start: 0.5rem;
    opacity: 1;
  }

  .sw-prose details[open] > summary:not(:where(.not-sw-prose *)) {
    margin-bottom: 1rem;
  }

  /* Summary marker styles */
  .sw-prose summary:not(:where(.not-sw-prose *))::marker,
  .sw-prose summary:not(:where(.not-sw-prose *))::-webkit-details-marker {
    display: none;
  }

  .sw-prose summary:not(:where(.not-sw-prose *))::before {
    --sw-details-marker-size: 1.25rem;

    background-color: currentColor;
    content: "";
    display: inline-block;
    height: var(--sw-details-marker-size);
    width: var(--sw-details-marker-size);
    margin-inline: calc((var(--sw-details-marker-size) / 4) * -1) 0.25rem;
    vertical-align: middle;
    -webkit-mask-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24'%3E%3Cpath d='M14.8 11.3 10.6 7a1 1 0 1 0-1.4 1.5l3.5 3.5-3.5 3.5a1 1 0 0 0 0 1.4 1 1 0 0 0 .7.3 1 1 0 0 0 .7-.3l4.2-4.2a1 1 0 0 0 0-1.4Z'/%3E%3C/svg%3E%0A");
    mask-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24'%3E%3Cpath d='M14.8 11.3 10.6 7a1 1 0 1 0-1.4 1.5l3.5 3.5-3.5 3.5a1 1 0 0 0 0 1.4 1 1 0 0 0 .7.3 1 1 0 0 0 .7-.3l4.2-4.2a1 1 0 0 0 0-1.4Z'/%3E%3C/svg%3E%0A");
    -webkit-mask-repeat: no-repeat;
    mask-repeat: no-repeat;
  }

  @media (prefers-reduced-motion: no-preference) {
    .sw-prose summary:not(:where(.not-sw-prose *))::before {
      transition: transform 0.2s ease-in-out;
    }
  }

  .sw-prose details[open] > summary:not(:where(.not-sw-prose *))::before {
    transform: rotateZ(90deg);
  }

  [dir="rtl"] .sw-prose summary:not(:where(.not-sw-prose *))::before,
  .sw-prose [dir="rtl"] summary:not(:where(.not-sw-prose *))::before {
    transform: rotateZ(180deg);
  }

  /* Summary with only a paragraph (MDX) */
  .sw-prose summary:not(:where(.not-sw-prose *)) p:only-child {
    display: inline;
  }

  /* --------------------------------------------------------------------------
   * Miscellaneous
   * -------------------------------------------------------------------------- */

  /* Abbreviations */
  .sw-prose abbr[title]:not(:where(.not-sw-prose *)) {
    text-decoration: underline dotted;
    cursor: help;
  }

  /* Mark/Highlight */
  .sw-prose mark:not(:where(.not-sw-prose *)) {
    background-color: --alpha(var(--color-warning) / 30%);
    color: var(--color-foreground);
    padding: 0.125em 0.25em;
    border-radius: 0.125rem;
  }

  /* Subscript and Superscript */
  .sw-prose :is(sub, sup):not(:where(.not-sw-prose *)) {
    font-size: 0.75em;
  }
</style>
