---
import type { HTMLAttributes } from "astro/types";
import { tv } from "tailwind-variants";

type Props = HTMLAttributes<"button">;

export const sidebarRail = tv({
  base: [
    "starwind-sidebar-rail",
    "absolute inset-y-0 z-20 hidden w-4 -translate-x-1/2 transition-all ease-linear sm:flex",
    "group-data-[side=left]:-right-4 group-data-[side=right]:left-0",
    "after:absolute after:inset-y-0 after:left-1/2 after:w-[2px]",
    "hover:after:bg-sidebar-border",
    "in-data-[side=left]:cursor-w-resize in-data-[side=right]:cursor-e-resize",
    "[[data-side=left][data-state=collapsed]_&]:cursor-e-resize",
    "[[data-side=right][data-state=collapsed]_&]:cursor-w-resize",
    "hover:group-data-[collapsible=offcanvas]:bg-sidebar",
    "group-data-[collapsible=offcanvas]:translate-x-0",
    "group-data-[collapsible=offcanvas]:after:left-full",
    "[[data-side=left][data-collapsible=offcanvas]_&]:-right-2",
    "[[data-side=right][data-collapsible=offcanvas]_&]:-left-2",
  ],
});

const { class: className, ...rest } = Astro.props;
---

<button
  type="button"
  class={sidebarRail({ class: className })}
  data-slot="sidebar-rail"
  data-sidebar="rail"
  aria-label="Toggle Sidebar"
  tabindex="-1"
  {...rest}></button>

<script>
  class SidebarRailHandler {
    private rail: HTMLElement;
    private provider: HTMLElement | null;

    constructor(rail: HTMLElement) {
      this.rail = rail;
      this.provider = rail.closest<HTMLElement>('[data-slot="sidebar-provider"]');
      this.init();
    }

    private init() {
      this.rail.addEventListener("click", this.handleClick.bind(this));
    }

    private handleClick() {
      if (this.provider) {
        this.provider.dispatchEvent(new CustomEvent("sidebar:toggle"));
      }
    }
  }

  const railInstances = new WeakMap<HTMLElement, SidebarRailHandler>();

  const setupSidebarRails = () => {
    document.querySelectorAll<HTMLElement>(".starwind-sidebar-rail").forEach((rail) => {
      if (railInstances.has(rail)) return;
      railInstances.set(rail, new SidebarRailHandler(rail));
    });
  };

  setupSidebarRails();
  document.addEventListener("astro:after-swap", setupSidebarRails);
  document.addEventListener("starwind:init", setupSidebarRails);
</script>
